<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gráfico de Dona con Datos de Google Sheets</title>

  <style>
  #chartdiv {
    width: 100%;
    height: 500px;
  }
  #loading {
    text-align: center;
    padding: 20px;
    font-family: sans-serif;
    color: #666;
  }
  </style>

  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
</head>
<body>

<div id="loading">Cargando datos del Google Sheet...</div>
<div id="chartdiv"></div>

<script>
// URL del CSV publicado de Google Sheets que me diste
const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQNAc8bcfiBqTMlVq3iSM_Hr7h7u1r2ckSoi1STmAS86xVwxEvulacsvnb3JV67LLQ1GtCXRB3M8eIP/pub?gid=0&single=true&output=csv';

// Función para parsear CSV manualmente (copiada de tu código)
function parseCSV(text) {
  const lines = text.split('\n').filter(line => line.trim() !== '');
  // NOTA: Usamos toLowerCase() para asegurar que la coincidencia de 'category' y 'value' funcione
  const headers = lines[0].split(',').map(h => h.trim().toLowerCase()); 
  
  const data = [];
  for (let i = 1; i < lines.length; i++) {
    const values = lines[i].split(',');
    if (values.length >= headers.length) {
      const row = {};
      headers.forEach((header, index) => {
        row[header] = values[index] ? values[index].trim() : '';
      });
      data.push(row);
    }
  }
  return data;
}

// *** LÓGICA DE CARGA DE DATOS USANDO FETCH (COMO EN TU EJEMPLO) ***
fetch(csvUrl)
  .then(response => {
    if (!response.ok) {
      throw new Error('No se pudo cargar el archivo CSV');
    }
    return response.text();
  })
  .then(csvText => {
    // 1. Parsear el CSV
    const parsedData = parseCSV(csvText);
    
    // 2. Ocultar mensaje de carga
    document.getElementById('loading').style.display = 'none';

    // 3. Transformar los datos para el gráfico de dona
    // Los nombres de columna deben coincidir con los campos 'categoryField' y 'valueField' de amCharts.
    // Asumimos que la primera columna del CSV es la Categoría (ej: "One") y la segunda es el Valor (ej: 10).
    const chartData = parsedData.map(row => ({
      category: row.category || row.Category || row[Object.keys(row)[0]] || '', // Usa el campo 'category' o la primera columna
      value: parseFloat(row.value || row.Value || row[Object.keys(row)[1]] || 0) // Usa el campo 'value' o la segunda columna
    })).filter(row => row.category && row.value > 0); // Filtrar filas inválidas
    
    // 4. Inicializar el gráfico con los datos cargados
    inicializarGrafico(chartData);
  })
  .catch(error => {
    // Mostrar error si la carga falla
    document.getElementById('loading').innerHTML = 
      '<p style="color: red;">Error al cargar los datos del Google Sheet.</p>' +
      '<p style="font-size: 12px;">Error: ' + error.message + '</p>';
    console.error('Error detallado:', error);
  });

// Función para inicializar el gráfico de dona
function inicializarGrafico(data) {
  if (!data || data.length === 0) {
    document.getElementById('loading').innerHTML = 
      '<p style="color: orange;">No se encontraron datos válidos en el CSV.</p>';
    return;
  }

  am5.ready(function() {

    // Create root element
    var root = am5.Root.new("chartdiv");

    // Set themes
    root.setThemes([
      am5themes_Animated.new(root)
    ]);

    // Create chart
    var chart = root.container.children.push(am5percent.PieChart.new(root, {
      layout: root.verticalLayout,
      innerRadius: am5.percent(50)
    }));

    // Create series
    var series = chart.series.push(am5percent.PieSeries.new(root, {
      valueField: "value",
      categoryField: "category",
      alignLabels: false
    }));

    // Configuración de Etiquetas de Datos y Tooltip (MODIFICACIONES ANTERIORES)
    series.labels.template.setAll({
      // Muestra la categoría y el valor: "One: 10", "Two: 9", etc.
      text: "{category}: {value}", 
      position: "outside", 
      centerX: am5.percent(0),
      centerY: am5.percent(0)
    });

    series.slices.template.setAll({
      tooltipText: "{category}: {value} ({valuePercentTotal.formatNumber('0.00')}%)"
    });

    
    // Establecer los datos obtenidos del CSV
    series.data.setAll(data);


    // Create legend
    var legend = chart.children.push(am5.Legend.new(root, {
      centerX: am5.percent(50),
      x: am5.percent(50),
      marginTop: 15,
      marginBottom: 15,
    }));

    // Asignar datos de la serie a la leyenda
    legend.data.setAll(series.dataItems);

    // Configuración de Leyenda (MODIFICACIONES ANTERIORES)
    legend.labels.template.setAll({
      text: "{category}" // Muestra solo el nombre de la categoría
    });

    legend.valueLabels.template.setAll({
      forceHidden: true // Oculta el porcentaje
    });


    // Play initial series animation
    series.appear(1000, 100);

  }); // end am5.ready()
}
</script>

</body>
</html>